<!-- This file has been generated by the concat.sh script. -->
<!-- Don't modify this file manually (you'll loose your changes) -->
<!-- but run the tool once more -->
<!-- Last refresh date: Tuesday, December 12, 2023, 13:59:00 -->

<!-- markdownlint-disable MD033 MD041 -->

# Docker &amp; docker-compose tips

![Banner](./banner.svg)

> List of tips and tricks for Docker

<!-- table-of-contents - start -->
* [Some useful bash scripts](#some-useful-bash-scripts)
  * [Check container](#check-container)
    * [Check the container exists (independently of the status)](#check-the-container-exists-independently-of-the-status)
    * [Return only the ID](#return-only-the-id)
* [Tips](#tips)
  * [Docker outside of Docker (aka DooD)](#docker-outside-of-docker-aka-dood)
    * [Tips for Dood](#tips-for-dood)
  * [Using regex in conditional statements](#using-regex-in-conditional-statements)<!-- table-of-contents - end -->

## Some useful bash scripts

### Check container

Let's imagine the `sonarqube` container.

#### Check the container exists (independently of the status)

```bash
docker ps -a -f name=sonarqube
```

Will return 

```text
CONTAINER ID   IMAGE              COMMAND                  CREATED      STATUS              PORTS                    NAMES
422f62c2fc23   sonarqube:latest   "/opt/sonarqube/dock…"   4 days ago   Up About a minute   0.0.0.0:9000->9000/tcp   sonarqube
```

or

```text
CONTAINER ID   IMAGE              COMMAND                  CREATED      STATUS                       PORTS     NAMES
422f62c2fc23   sonarqube:latest   "/opt/sonarqube/dock…"   4 days ago   Exited (130) 3 seconds ago             sonarqube
```

As we can see, the `docker ps` command will return our container but, perhaps, did we make sure the container is running:

```bash
docker ps -a -f name=sonarqube -f status=running
```

#### Return only the ID

The `-q` flag means `qiet` and will only return the ID:


```bash
docker ps -a -q -f name=sonarqube
```

This will return only the `ID`, like `22f62c2fc23`.

## Tips

### Docker outside of Docker (aka DooD)

By sharing the `/var/run/docker.sock` file with your container, it's possible to interact with the Docker daemon on your host. This technique is called *Docker outside of Docker (aka DooD)*.

Run an Alpine image (default user: `root`) and share the file:

```bash
docker run -it --rm --name DockerOutsideOfDocker -v /var/run/docker.sock:/var/run/docker.sock alpine sh
```

Then install Docker client in the container

```bash
apk update && apk add -U docker
```

Now, you can, from inside the container, run commands like:

```bash
docker container list
docker container stop <CONTAINER_ID>
docker container rm <CONTAINER_ID>

docker image list
docker run -it --rm <IMAGE_NAME> sh
```

#### Tips for Dood

You can mount the `docker.sock` file directly from your `docker-compose.yml` file:

```yml
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
```

### Using regex in conditional statements

Sometimes, we wish to be able to check some variables and have a `if ... else` statement.

Real use case is when we're using xDebug. Settings in the `docker-php-ext-xdebug.ini` are not the same for version 2 or greater.

For v2, we'll use f.i. `xdebug.remote_enable=1` while it'll be `xdebug.mode=debug` (f.i.) for v3 or above.

So, we need to check the major version. This can be done like this:

```dockerfile
ARG XDEBUG_VERSION=2.9.8

RUN if [ "$XDEBUG_VERSION" = "2.9.8" ]; then \
        echo "perfect match, it's 2.9.8"; \
    fi

RUN if  [ $(expr "$XDEBUG_VERSION" : "2.*" ) -eq 0 ]; then \
        echo "VERSION 3 or greater"; \ 
    else \
        echo "VERSION 2"; \ 
    fi
```
